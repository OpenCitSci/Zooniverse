// Generated by CoffeeScript 1.3.3
(function() {
  var $, Api, ProxyFrame, _,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  $ = require('jqueryify');

  _ = require('underscore/underscore');

  ProxyFrame = require('proxy_frame');

  Api = (function() {

    Api.requests = {};

    Api.ready = false;

    Api.proxy = void 0;

    function Api(host) {
      this.host = host;
      this.process = __bind(this.process, this);

      this.respond = __bind(this.respond, this);

      this.loaded = __bind(this.loaded, this);

      if (!Api.proxy) {
        this.createProxy();
      }
    }

    Api.prototype.createProxy = function() {
      Api.proxy = new ProxyFrame(this.host);
      Api.proxy.bind('load', this.loaded);
      return Api.proxy.bind('response', this.respond);
    };

    Api.prototype.loaded = function() {
      var id, request, _ref, _results;
      Api.ready = true;
      _ref = Api.requests;
      _results = [];
      for (id in _ref) {
        request = _ref[id];
        if (!request.processed) {
          _results.push(this.process(id));
        }
      }
      return _results;
    };

    Api.prototype.request = function(type, url, data, done, fail) {
      var headers, id, message;
      id = this.nextId();
      headers = {};
      if (typeof data === 'function') {
        fail = done;
        done = data;
        data = null;
      }
      message = {
        id: id,
        type: type,
        url: url,
        data: data,
        done: done,
        fail: fail,
        headers: headers
      };
      Api.requests[id] = message;
      if (Api.ready) {
        return this.process(id);
      } else {
        return message.processed = false;
      }
    };

    Api.prototype.respond = function(ev, message) {
      var request;
      request = Api.requests[message.id];
      if (message.failure) {
        if (typeof request.fail === "function") {
          request.fail(message.response);
        }
      } else {
        if (typeof request.done === "function") {
          request.done(message.response);
        }
      }
      return delete Api.requests[message.id];
    };

    Api.prototype.process = function(id) {
      var data, headers, message, type, url, _ref;
      Api.requests[id].processed = true;
      _ref = Api.requests[id], id = _ref.id, type = _ref.type, url = _ref.url, data = _ref.data, headers = _ref.headers;
      message = {
        id: id,
        type: type,
        url: url,
        data: data,
        headers: headers
      };
      return Api.proxy.send(message);
    };

    Api.prototype.nextId = function() {
      return _.uniqueId('api-');
    };

    return Api;

  })();

  module.exports = Api;

}).call(this);
