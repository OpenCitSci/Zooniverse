// Generated by CoffeeScript 1.6.3
(function() {
  var $, DEFAULT_LANGUAGE_CODE, EventEmitter, LanguageManager, _base, _ref,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  EventEmitter = ((_ref = window.zooniverse) != null ? _ref.EventEmitter : void 0) || require('./event-emitter');

  $ = window.jQuery;

  DEFAULT_LANGUAGE_CODE = 'en';

  LanguageManager = (function(_super) {
    __extends(LanguageManager, _super);

    LanguageManager.current = null;

    LanguageManager.prototype.translations = null;

    function LanguageManager(_arg) {
      var code, localCode, localStrings, strings, _ref1, _ref2, _ref3,
        _this = this;
      _ref1 = _arg != null ? _arg : {}, this.translations = _ref1.translations, code = _ref1.code, strings = _ref1.strings;
      if (this.translations == null) {
        this.translations = window.AVAILABLE_TRANSLATIONS || {};
      }
      localCode = (function() {
        try {
          return localStorage.getItem('zooniverse-language-code');
        } catch (_error) {}
      })();
      localStrings = JSON.parse((function() {
        try {
          return localStorage.getItem('zooniverse-language-strings');
        } catch (_error) {}
      })());
      if ((localCode != null) && (localStrings != null)) {
        setTimeout(function() {
          return _this.trigger('change-language', [localCode, localStrings]);
        });
      }
      code || (code = (function() {
        try {
          return location.search.match(/lang=([\$|\w]+)/)[1];
        } catch (_error) {}
      })());
      code || (code = localCode);
      code || (code = (_ref2 = navigator.language) != null ? _ref2.split('-')[0] : void 0);
      code || (code = (_ref3 = navigator.userLanguage) != null ? _ref3.split('-')[0] : void 0);
      code || (code = DEFAULT_LANGUAGE_CODE);
      this.strings || (this.strings = localStrings);
      this.strings || (this.strings = {});
      this.constructor.current = this;
      setTimeout(function() {
        return _this.setLanguage(code);
      });
    }

    LanguageManager.prototype.setLanguage = function(code, callback) {
      var request, _ref1,
        _this = this;
      if (code in this.translations) {
        if (typeof ((_ref1 = this.translations[code]) != null ? _ref1.strings : void 0) === 'string') {
          request = $.getJSON(this.translations[code].strings);
          request.done(function(data) {
            _this.translations[code].strings = data;
            return _this.setLanguage(code, callback);
          });
          return request.fail(function() {
            _this.trigger('language-fetch-fail');
            return typeof callback === "function" ? callback.apply(null, arguments) : void 0;
          });
        } else {
          localStorage.setItem('zooniverse-language-code', code);
          localStorage.setItem('zooniverse-language-strings', JSON.stringify(this.translations[code].strings));
          this.trigger('change-language', [code, this.translations[code].strings]);
          return typeof callback === "function" ? callback(this.currentStrings) : void 0;
        }
      }
    };

    return LanguageManager;

  })(EventEmitter);

  if (window.zooniverse == null) {
    window.zooniverse = {};
  }

  if ((_base = window.zooniverse).lib == null) {
    _base.lib = {};
  }

  window.zooniverse.lib.LanguageManager = LanguageManager;

  if (typeof module !== "undefined" && module !== null) {
    module.exports = LanguageManager;
  }

}).call(this);
