// Generated by CoffeeScript 1.4.0
(function() {
  var $, Api, BaseModel, Classification, RESOLVED_STATE, Recent, _base, _ref, _ref1,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __slice = [].slice;

  if ((_ref = window.zooniverse) == null) {
    window.zooniverse = {};
  }

  if ((_ref1 = (_base = window.zooniverse).models) == null) {
    _base.models = {};
  }

  BaseModel = zooniverse.models.BaseModel || require('./base-model');

  Api = zooniverse.Api || require('../lib/api');

  Recent = zooniverse.models.Recent || require('../models/recent');

  $ = window.jQuery;

  RESOLVED_STATE = (new $.Deferred).resolve().state();

  Classification = (function(_super) {

    __extends(Classification, _super);

    Classification.pending = JSON.parse(localStorage.getItem('pending-classifications')) || [];

    Classification.sentThisSession = 0;

    Classification.prototype.subject = null;

    Classification.prototype.annotations = null;

    Classification.prototype.favorite = false;

    Classification.prototype.started = null;

    Classification.prototype.agent = null;

    function Classification() {
      var _ref2;
      Classification.__super__.constructor.apply(this, arguments);
      if ((_ref2 = this.annotations) == null) {
        this.annotations = [];
      }
      this.started = (new Date).toUTCString();
      this.agent = window.navigator.userAgent;
    }

    Classification.prototype.annotate = function(annotation) {
      return this.annotations.push(annotation);
    };

    Classification.prototype.toJSON = function() {
      var output;
      output = {
        classification: {
          subject_ids: [this.subject.id],
          annotations: this.annotations.concat([
            {
              started: this.started
            }, {
              agent: this.agent
            }
          ])
        }
      };
      if (this.favorite) {
        output.favorite = true;
      }
      return output;
    };

    Classification.prototype.send = function(done, fail) {
      var asJSON, post, url, _ref2,
        _this = this;
      if (!(this.subject.metadata.tutorial || this.subject.metadata.empty)) {
        this.constructor.sentThisSession += 1;
      }
      url = "/projects/" + Api.current.project + "/workflows/" + this.subject.workflow_ids[0] + "/classifications";
      asJSON = this.toJSON();
      post = (_ref2 = Api.current).post.apply(_ref2, [url, asJSON].concat(__slice.call(arguments)));
      post.done(function() {
        var classification, pendingPosts, _i, _len, _ref3, _results;
        pendingPosts = [];
        _ref3 = _this.constructor.pending;
        _results = [];
        for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
          classification = _ref3[_i];
          _results.push((function(classification) {
            var latePost;
            _this.trigger('sending-pending', [classification]);
            latePost = Api.current.post(url, classification);
            pendingPosts.push(latePost);
            latePost.done(function() {
              var c, i, _j, _len1, _ref4, _results1;
              _this.trigger('send-pending', [classification]);
              _ref4 = _this.constructor.pending;
              _results1 = [];
              for (i = _j = 0, _len1 = _ref4.length; _j < _len1; i = ++_j) {
                c = _ref4[i];
                if (!(c === classification)) {
                  continue;
                }
                _this.constructor.pending.splice(i, 1);
                break;
              }
              return _results1;
            });
            latePost.fail(function() {
              return _this.trigger('send-pending-fail', [classification]);
            });
            return $.when.apply($, pendingPosts).always(function() {
              var i, _j, _ref4;
              for (i = _j = _ref4 = pendingPosts.length - 1; _ref4 <= 0 ? _j <= 0 : _j >= 0; i = _ref4 <= 0 ? ++_j : --_j) {
                if (pendingPosts[i].state() === RESOLVED_STATE) {
                  _this.constructor.pending.splice(i, 1);
                }
              }
              return localStorage.setItem('pending-classifications', JSON.stringify(_this.constructor.pending));
            });
          })(classification));
        }
        return _results;
      });
      post.fail(function() {
        _this.constructor.pending.push(asJSON);
        localStorage.setItem('pending-classifications', JSON.stringify(_this.constructor.pending));
        if (typeof console !== "undefined" && console !== null) {
          console.warn("Post failed! " + _this.constructor.pending.length + " pending");
        }
        return _this.trigger('pending');
      });
      return this.trigger('send');
    };

    return Classification;

  })(BaseModel);

  window.zooniverse.models.Classification = Classification;

  if (typeof module !== "undefined" && module !== null) {
    module.exports = Classification;
  }

}).call(this);
